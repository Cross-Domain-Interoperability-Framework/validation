@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix schema: <https://schema.org/> .
@prefix cdifd: <https://cdif.org/validation/0.1/shacl#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix dcterms: <http://purl.org/dc/terms/>.


cdifd:CDIFDatasetRecommendedShape a sh:NodeShape ;
# only apply to elements that are child of root dataset
sh:target [
  a sh:SPARQLTarget ;
  sh:prefixes (
    [ sh:prefix "schema" ; sh:namespace "https://schema.org/" ]
    [ sh:prefix "ada" ; sh:namespace "https://ada.astromat.org/metadata/" ]
	[ sh:prefix "xsd" ; sh:namespace "http://www.w3.org/2001/XMLSchema#" ]
	[ sh:prefix "dcterms" ; sh:namespace "http://purl.org/dc/terms/" ]
  ) ;
  sh:select """
    SELECT ?this WHERE {
      ?this a schema:Dataset .
      FILTER NOT EXISTS {
        ?parent a schema:Dataset .
        ?parent ?p ?this .
        FILTER (?parent != ?this)
      }
    }
  """ ;
] ;	
    sh:property	
		cdifd:metadataIdentifierProperty,  
		# +
		cdifd:resourceIdentifierProperty,
		# +
		cdifd:nameProperty,
		# +
		cdifd:metadataProfileProperty,
		# +
		cdifd:otherIdentifierProperty, 
		# +
		cdifd:responsiblePartyProperty,
		# +
		cdifd:contributorProperty,
		# + 
		cdifd:datePublishedProperty,
		# +
        cdifd:keywordsResourceProperty,
		cdifd:keywordsNoCommaTest,
		# +
		cdifd:spatialExtentProperty;
.
cdifd:metadataIdentifierProperty
# identifier for the graphNode representation, not the entity described by the content of the graph node
    a sh:PropertyShape ;
    sh:path schema:subjectOf ;
    sh:nodeKind sh:IRI ;
	sh:severity sh:Warning ;
    sh:message "The URI for the metadata record should be the @id value for the 'subjectOf' element in the JSON instance document tree or '@id':{uri} in a separate graph node with 'identifier':'@id' of the node containing the resource description" 
    .
	
cdifd:resourceIdentifierProperty
# identifier for the graphNode representation, not the entity described by the content of the graph node
    a sh:PropertyShape ;
    sh:path schema:identifier ;
	sh:minCount 1 ;
    sh:datatype xsd:string ;
	sh:severity sh:Warning ;
    sh:message "An identifier for the documented material sample must be provided" 
    .
	
cdifd:nameProperty
# names must be a literal, .
    a sh:PropertyShape ;
    sh:path schema:name;
	sh:minCount 1 ;
    sh:datatype xsd:string ;
	#sh:minLength 10 ;
	sh:severity sh:Warning ;
    sh:message "a name for the described resource must be provided. This name should be unique in the scope of the metadata providers corpus" 
    .
	
cdifd:metadataProfileProperty
# Metadata needs to identify conventions followed in the serialization of this record.
    a sh:PropertyShape ;
    sh:path ( schema:subjectOf dcterms:conformsTo ) ;
	sh:minCount 1 ;
    sh:nodeKind sh:IRIOrLiteral ;
	sh:severity sh:Warning ;
    sh:message "provide identifiers for specifications and datatypes used in this record to provide guidance for machine agents processing the metadata record" 
    .
	
cdifd:otherIdentifierProperty
    a sh:PropertyShape ;
    sh:path schema:sameAs ;
    sh:minCount 0 ;
    sh:nodeKind sh:IRIOrLiteral ;
    sh:severity sh:Info ;
    sh:message "other identifiers for the described resource" ;
    .
	
cdifd:responsiblePartyProperty
    a sh:PropertyShape ;
    sh:path [sh:alternativePath ( schema:creator schema:editor schema:publisher ) ]  ;
    sh:or (  [  sh:class  schema:Person ]
             [   sh:class  schema:Organization ] )  ;
	sh:minCount 1;
   	sh:message "Optional: Recommended practice is to identify at least one responsible party as the source authority for the dataset. Options include  creator, editor, or publisher. Each is either a schema:Person or schema:Organization and MUST have at least a name." ;
    sh:description "https://cross-domain-interoperability-framework.github.io/cdifbook/metadata/schemaorgimplementation.html" ;
    sh:severity sh:Info 
    .
	
cdifd:contributorProperty
    a sh:PropertyShape ;
    sh:path schema:contributor   ;
    sh:class schema:Role ;
	sh:minCount 0;
   	sh:message "Optional: Contributors are expected to be assigned a role, Using the  convoluted Role construct defined by schema.org" ;
    sh:description "https://cross-domain-interoperability-framework.github.io/cdifbook/metadata/schemaorgimplementation.html" ;
    sh:severity sh:Info 
    .

cdifd:datePublishedProperty
    a sh:PropertyShape ;
    sh:path schema:datePublished;
	# pyshacl doesn't seem to work validating xsd:date or xsd:dateTime in JSON-LD
    # sh:datatype xsd:dateTime ;
	sh:minCount 1 ;
	sh:datatype xsd:string ;
	# messy regex to screen for ISO8601 formats
	sh:pattern "^[1-2][0-9]{3}-([0][1-9]|[1][0-2])(-([0-2][0-9]|[3][0-1])(T([0-1][0-9]|[2][0-3]):[0-5][0-9](:[0-5][0-9](Z|[+-][0-2][0-9]:[0-5][0-9])?)?)?)?$" ;
	sh:severity sh:Info ;
    sh:message "Please provide a publication or release date, using ISO8601 format with at least a year and a month." 
    .
	
cdifd:keywordsResourceProperty
    a sh:PropertyShape ;
    sh:path schema:keywords ;
    sh:minCount 1 ;
    sh:datatype xsd:string ;
    sh:severity sh:Info ;
    sh:message "A resource should include descriptive keywords as an array of strings" ;
    sh:description "https://cross-domain-interoperability-framework.github.io/cdifbook/metadata/schemaorgimplementation.html" ;
    .
	
cdifd:keywordsNoCommaTest
#should throw warning if there is a comma character in a keyword string. Not working... ?WHY?
    a sh:PropertyShape ;
    sh:path schema:keywords ;
	sh:datatype xsd:string ;
	#regex for a string with a comma
	sh:pattern "^[^,]*$" ; 
    sh:severity sh:Warning ;
    sh:message "If there are multiple keywords, they should be in an array; an individual keyword MUST not contain a comma character" ;
    sh:description "https://cross-domain-interoperability-framework.github.io/cdifbook/metadata/schemaorgimplementation.html" ;
    .

cdifd:spatialExtentProperty
    a sh:PropertyShape ;
    sh:path schema:spatialCoverage;
    sh:minCount 1 ;
    sh:class schema:Place ;
      sh:or (  [sh:path schema:geo ;
                  sh:or (  [  sh:class  schema:GeoCoordinates ]
                           [  sh:class  schema:GeoShape ] )  ;
	              sh:minCount 1 ;
	              sh:message "spatial location MUST be specified either with GeoCoordinates lat/long pairs (for point location), or with GeoShape  Line or Box." ;]
               [sh:path schema:name;
                  sh:datatype xsd:string;
                  sh:minCount 1 ]
      );
    sh:severity sh:Info ;
    sh:message "Recommended: provide a spatial coverage description if applicable using schema:Place, either a place name,  point location(s) (GeoCoordinates), or GeoShape (bounding box, line profile location, or polygon)." ;
    .
 
 	
	
#  end base property definitions

#  node shapes used by base property definitions
cdifd:CDIFPersonShape
    a sh:NodeShape ;
    sh:targetClass schema:Person ;
	sh:property [
		sh:path schema:identifier;
		sh:minCount 1 ;
		sh:nodeKind sh:IRIOrLiteral ;
		sh:severity sh:Info ;
		sh:message "a person should have an identifier that is a URI; use of ORCID is strongly encouraged" ; 
	];
    sh:property cdifd:nameProperty ;
	sh:property cdifd:contactPointProperty ;
	sh:property cdifd:affiliationProperty ;
	sh:message "A person must a name provided; affiliation to an organization and identifier are strongly recommended." 
	.

cdifd:CDIFOrganizationShape
    a sh:NodeShape ;
    sh:targetClass schema:Organization ;
    sh:property cdifd:nameProperty;
    sh:message "Organization must have a name at least 15 characters long; Make it useful for users!!" 
	.

cdifd:CDIFRoleShape
    a sh:NodeShape ;
    sh:targetClass schema:Role ;
	sh:property cdifd:roleNameProperty;
	# CDIF only uses Role on schema:contributor
    sh:property [
	    sh:path schema:contributor  ;
		sh:or (  [  sh:class  schema:Person ]
				 [   sh:class  schema:Organization ] )  ;
		sh:minCount 1;
		sh:message "a Role must be filled by either a Person or an organization " ;
		sh:description "https://cross-domain-interoperability-framework.github.io/cdifbook/metadata/schemaorgimplementation.html" ;
		sh:severity sh:Info 
	];
    sh:message "The schema.org consstruct for assigining a role to a contributor nests a second schema:contributor node inside a schame:contributor node." 
	.

cdifd:geoCoordinatesNode
	a sh:NodeShape ;
    sh:targetClass schema:GeoCoordinates ;
	sh:property [ sh:path schema:latitude ;
	#pyshacl seems to assume that decimal numbers are xsd:doubles...
	# pyshacl doesn't seem to pay attention to min and max values
			sh:or ( [sh:datatype xsd:double ]
					[sh:datatype xsd:integer ] );
			sh:minValue -90.0;
			sh:maxValue 90.0;
			sh:minCount 1 ] ;
	sh:property [sh:path schema:longitude ;
			sh:or ( [sh:datatype xsd:double ]
					[sh:datatype xsd:integer ] );
			sh:minValue -180.0;
			sh:maxValue 180.0;
			sh:minCount 1 ] ;
	   sh:message "GeoCoodinates must include latitude between -90 and 90, and longitude between -180 and 180." ;
	.

  cdifd:geoShapeNode
	a sh:NodeShape ;
    sh:targetClass schema:GeoShape ;
	sh:property
		[sh:path [sh:alternativePath ( schema:line schema:box) ];
			sh:datatype xsd:string;
			sh:minCount 1 ;
            sh:message "geoshape must include a line or box geometry as a string of latitude longitude pairs"
		]
.	

#  properties for node shapes

cdifd:contactPointProperty 
	sh:path schema:email;
	sh:minCount 0 ;
	sh:datatype xsd:string ;
    sh:pattern "[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,}$" ;
	sh:severity sh:Info ;
	sh:message "a contact point should be provided; an e-mail address is strongly recommended" ; 
	.

cdifd:affiliationProperty
# affiliation is always with an organization
    a sh:PropertyShape ;
    sh:path schema:affiliation ;
    sh:class  schema:Organization  ;
	sh:minCount 0 ;
	sh:severity sh:Warning ;
    sh:message "Optional: an affiliation must have object schema:Organization" 
    .
	
cdifd:roleNameProperty
# affiliation is always with an organization
    a sh:PropertyShape ;
    sh:path schema:roleName;
	sh:minCount 1 ;
    sh:or ( [sh:nodeKind sh:IRI] 
		[sh:datatype xsd:string] ) ;
	sh:severity sh:Warning ;
    sh:message "a Role must provide a roleName, ideally the value is a term from a controlled vocabulary or an IRI for a role concept." 
    .
	
