@prefix schema: <http://schema.org/> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix cdifd: <https://cdif.org/validation/0.1/shacl#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix soso: <http://science-on-schema.org/1.2.3/validation/shacl#> .
@prefix datacite: <http://purl.org/spar/datacite/> .
@prefix time: <http://www.w3.org/2006/time#>.


# copy from Doug Fils work on GeoCODES schacl validation
# SMR 2022-07-25
# Use Doug Fils documentation for Ocean Info Hub and 
# ESIP Fed science-on-schema.org
# change base namespace from to cdifd:
# SMR 2025-06-10 for CDIF and AstroMat

cdifd:CDIFDatasetRecommendedShape
    a sh:NodeShape ;
	# rules apply only to the root Dataset node, not any child Dataset node
sh:target [
  a sh:SPARQLTarget ;
  sh:prefixes (
    [ sh:prefix "schema" ; sh:namespace "https://schema.org/" ]
    [ sh:prefix "ada" ; sh:namespace "https://ada.astromat.org/metadata/" ]
  ) ;
  sh:select """
    SELECT ?this WHERE {
      ?this a schema:Dataset .
      FILTER NOT EXISTS {
        ?parent a schema:Dataset .
        ?parent ?p ?this .
        FILTER (?parent != ?this)
      }
    }
  """ ;
] ;
    sh:message "CDIF validation suite recommended properties, for basic Dataset discovery metadata" ;
    sh:description "https://cross-domain-interoperability-framework.github.io/cdifbook/metadata/schemaorgimplementation.html" ;	
    sh:property	
		cdifd:metadataIdentifierProperty,  
		# +
		cdifd:resourceIdentifierProperty,
		# +
        cdifd:otherIdentifierProperty,
		# +
		cdifd:nameProperty,
		# +
		cdifd:metadataProfileProperty,
		# +
#		cdifd:descriptionProperty,
        cdifd:responsiblePartyProperty,
		# + 
		cdifd:datePublishedProperty,
		# +
        cdifd:keywordsResourceProperty,
		# +
		cdifd:keywordsNoCommaTest
		# +
		cdifd:spatialExtentProperty,
		# +
		cdifd:temporalExtentProperty,
		# +
        cdifd:variableMeasuredProperty,
		# +
		cdifd:rightsProperty,
		cdifd:policiesProperty,
		cdifd:relatedResourceProperty,
        cdifd:fundingProperty,
		cdifd:distributionProperty,
		cdifd:distributionAgentProperty,
		cdifd:metadataMetadataProperty,
        cdifd:checksumProperty,
		cdifd:citationProperty,
		# +
		cdifd:subjectOfProperty,
		# +
		
.

cdifd:metadataIdentifierProperty
# identifier for the graphNode representation, not the entity described by the content of the graph node
    a sh:PropertyShape ;
    sh:path schema:subjectOf ;
    sh:nodeKind sh:IRI ;
	sh:severity sh:Warning ;
    sh:message "The URI for the metadata record should be the @id value for the 'subjectOf' element in the JSON instance document tree or '@id':{uri} in a separate graph node with 'identifier':'@id' of the node containing the resource description" 
    .
# from ChatGPT	


# Metadata identifier in CDIF is the ID in @id for a subjectOf element. The about property in the subjectOf elemetn links the metadata properties to the metadata record with the @id = the value in sdo:about.
ex:metadataIdentifierPropertyTop
  a sh:NodeShape ;
  sh:targetClass schema:Dataset ;
  sh:sparql [
    a sh:SPARQLConstraint ;
    sh:select """
      SELECT ?node2
	 
      WHERE {
		?node1 a schema:Dataset . 
		?node2 a schema:Dataset.
        FILTER NOT EXISTS {
			?node1 ?predicate ?node2 .
        }
		FILTER ( ?node1 != ?node2)
      }
    """ ;
  ] .
	
	
	 sh:sparql [
    a sh:SPARQLConstraint ;
    sh:message "" ;
    sh:select """
      SELECT ?this 
      WHERE {
		?node1 a schema:Dataset . 
		?node1 ?predicate ?this .
		FILTER ( ?node1 != ?this)
      }
    """ ;
  ] ;
	
	
cdifd:resourceIdentifierProperty
# identifier for the graphNode representation, not the entity described by the content of the graph node
    a sh:PropertyShape ;
    sh:path schema:identifier ;
	sh:minCount 1 ;
    sh:datatype xsd:string ;
	sh:severity sh:Warning ;
    sh:message "An identifier for the documented material sample must be provided" 
    .

cdifd:otherIdentifierProperty
    a sh:PropertyShape ;
    sh:path schema:sameAs ;
    sh:minCount 0 ;
    sh:nodeKind sh:IRIOrLiteral ;
    sh:severity sh:Info ;
    sh:message "other identifiers for the described resource" ;
    .

cdifd:nameProperty
# names must be a literal, at least 15 char long.
    a sh:PropertyShape ;
    sh:path schema:name;
	sh:minCount 1 ;
    sh:nodeKind sh:Literal ;
	sh:minLength 10 ;
	sh:severity sh:Warning ;
    sh:message "a name for the described resource must be provided, at least 10 char long. This name should be unique in the scope of the metadata providers corpus" 
    .
	
cdifd:metadataProfileProperty
# Metadata needs to identify conventions followed in the serialization of this record.
    a sh:PropertyShape ;
    sh:path schema:subjectOf/dcterms:conformsTo ;
	sh:minCount 1 ;
    sh:nodeKind sh:Literal ;
	sh:severity sh:Warning ;
    sh:message "provide identifiers for specifications and datatypes used in this record to provide guidance for machine agents processing the metadata record" 
    .

cdifd:responsiblePartyProperty
    a sh:PropertyShape ;
    sh:path [sh:alternativePath ( schema:creator schema:editor schema:contributor  schema:publisher ) ]  ;
    sh:or (  [  sh:class  schema:Person ]
             [   sh:class  schema:Organization ] )  ;
	sh:minCount 1;
   	sh:message "Optional: Recommended practice is to identify at least one responsible party as the source authority for the dataset. Options include  creator, editor, contributor, or publisher. Each is either a schema:Person or schema:Organization and MUST have at least a name." ;
    sh:description "https://cross-domain-interoperability-framework.github.io/cdifbook/metadata/schemaorgimplementation.html" ;
    sh:severity sh:Info 
    .
	
cdifd:datePublishedProperty
    a sh:PropertyShape ;
    sh:path schema:datePublished;
    sh:nodeKind sh:Literal ;
	sh:severity sh:Info ;
    sh:message "Please provide a publication or release date." 
    .

cdifd:CDIFPersonShape
    a sh:NodeShape ;
    sh:targetClass schema:Person ;
	sh:property cdifd:affiliationProperty;
    sh:property cdifd:nameProperty ;
	sh:message "A person must a name provided; affiliation to an organization and identifier are strongly recommended." 
	.

cdifd:CDIFOrganizationShape
    a sh:NodeShape ;
    sh:targetClass schema:Organization ;
    sh:property cdifd:nameProperty;
    sh:message "Organization must have a name at least 15 characters long; Make it useful for users!!" 
.

cdifd:affiliationProperty
# affiliation is always with an organization
    a sh:PropertyShape ;
    sh:path schema:affiliation ;
    sh:class  schema:Organization  ;
	sh:severity sh:Warning ;
    sh:message "Optional: an affiliation must have object schema:Organization" 
    .
	
#start specific properties
cdifd:mainEntityProperty
    a sh:PropertyShape ;
    sh:path schema:mainEntity ;
	sh:and (
	   [sh:class schema:CreativeWork ] 
	   [sh:path schema:url ;
	      sh:hasValue "http://schema.org/Dataset" ]
	);
	sh:severity sh:Info ;
    sh:message "schema:mainEntity documents what kind of resource the metadadata record describes; optional for Datasets."@en ;
    .

cdifd:keywordsResourceProperty
    a sh:PropertyShape ;
    sh:path schema:keywords ;
    sh:minCount 1 ;
    sh:nodeKind sh:Literal ;
    sh:severity sh:Info ;
    sh:message "A resource should include descriptive keywords as an array of strings" ;
    sh:description "https://cross-domain-interoperability-framework.github.io/cdifbook/metadata/schemaorgimplementation.html" ;
    .
	
cdifd:keywordsNoCommaTest
#should throw warning if there is a comma character in a keyword string. Not working... ?WHY?
    a sh:PropertyShape ;
    sh:path schema:keywords ;
	#regex for a string without a comma
	sh:pattern "^(?!.+,).+" ;
#	sh:maxCount 0; 
    sh:severity sh:Warning ;
    sh:message "If there are multiple keywords, they should be in an array; an individual keyword MUST not contain a comma character" ;
    sh:description "https://cross-domain-interoperability-framework.github.io/cdifbook/metadata/schemaorgimplementation.html" ;
    .
	
cdifd:citationProperty
    a sh:PropertyShape ;
    sh:path schema:citation ;
    sh:severity sh:Info ;
    sh:message "schema:citation is not recommended for use in CDIF because of semantic ambiguity. If you want to provide a recommended citation for the resource described by the record, use dcterms:bibliographicCitation; if you want to cite related resources, use schema:isRelatedTo." ;
    sh:description "https://cross-domain-interoperability-framework.github.io/cdifbook/metadata/schemaorgimplementation.html" ;
    .

cdifd:subjectOfProperty
    a sh:PropertyShape ;
    sh:path schema:subjectOf ;
    sh:or (
 	[sh:class schema:DataDownload ;
     		sh:property [sh:path schema:encodingFormat ;
	   			sh:nodeKind sh:IRIOrLiteral ;
    			        sh:minCount 1 ] ;
  		sh:property [sh:path schema:contentUrl ;
	  			sh:nodeKind sh:IRIOrLiteral;
    			        sh:minCount 1] 
 		] 
        [sh:class schema:CreativeWork ;
            sh:property [sh:path schema:name;
             	sh:nodeKind sh:Literal;
                  sh:minCount 1;
                  sh:message "a linked resource should have a name to label the link" ] ;
             sh:property [sh:path schema:url;
             	sh:nodeKind sh:Literal;
                  sh:minCount 1;
                  sh:message "a linked resource with subjectOf MUST have a url to get the resource"] 
         ]
     );
    sh:severity sh:Warning ;
    sh:message "SubjectOf property links from a graph node to a metadata record about the representation of that node.  The subject of this 'subjectOf' triple should be the metadata record that documents the resoure of interest in the world" ;
    .

cdifd:spatialExtentProperty
    a sh:PropertyShape ;
    sh:path schema:spatialCoverage;
    sh:minCount 0 ;
    sh:class schema:Place ;
      sh:or (  [sh:path schema:geo ;
                  sh:or (  [  sh:class  schema:GeoCoordinates ]
                           [  sh:class  schema:GeoShape ] )  ;
	              sh:minCount 1 ;
	              sh:message "spatial location MUST be specified eitehr with GeoCoordinates lat/long pairs (for point location), or with GeoShape  Line, Box or Polygon." ;]
               [sh:path schema:name;
                  sh:nodeKind sh:Literal;
                  sh:minCount 1 ]
      );
    sh:severity sh:Info ;
    sh:message "Recommended: provide a spatial coverage description if applicable using schema:Place, either a place name,  point location(s) (GeoCoordinates), or GeoShape (bounding box, line profile location, or polygon)." ;
    .
 
 cdifd:geoCoordinatesNode
	a sh:NodeShape ;
    sh:targetClass schema:GeoCoordinates ;
	sh:property [ sh:path schema:latitude ;
	#pyshacl seems to assume that decimal numbers are xsd:doubles...
	# pyshacl doesn't seem to pay attention to min and max values
			sh:or ( [sh:datatype xsd:double ]
					[sh:datatype xsd:integer ] );
			sh:minValue -90.0;
			sh:maxValue 90.0;
			sh:minCount 1 ] ;
	sh:property [sh:path schema:longitude ;
			sh:or ( [sh:datatype xsd:double ]
					[sh:datatype xsd:integer ] );
			sh:minValue -180.0;
			sh:maxValue 180.0;
			sh:minCount 1 ] ;
	   sh:message "GeoCoodinates must include latitude between -90 and 90, and longitude between -180 and 180." ;
	.

  cdifd:geoShapeNode
	a sh:NodeShape ;
    sh:targetClass schema:GeoShape ;
	sh:property
		[sh:path [sh:alternativePath ( schema:line schema:polygon schema:box) ];
			sh:datatype xsd:string;
			sh:minCount 1 ;
            sh:message "geoshape must include a line, polygon or box geometry as a string of latitude longitude pairs"
		]
.

cdifd:temporalExtentProperty
	a sh:PropertyShape ;
	sh:path schema:temporalCoverage ;
	sh:minCount 0 ;
	sh:or (
		[sh:class time:ProperInterval ; ] 
		[sh:nodeKind sh:IRIOrLiteral ;]
          );
	sh:message "temporalCoverage problem; need either an ISO 8601 dateTime or a time:ProperInterval" ;
	.
	

cdifd:timeIntervalNode
	a sh:NodeShape ;
    sh:targetClass time:ProperInterval ;
	sh:property
		[ sh:path time:hasBeginning ;
		sh:class time:Instant ;
		sh:minCount 1;
		sh:message "A time interval must have a beginning "
		] ;
	sh:property
		[ sh:path time:hasEnd ;
		sh:class time:Instant ;
		sh:minCount 1;
		sh:message "A time interval must have an end "
		]
	.

cdifd:timeInstantNode
	a sh:NodeShape; 
	sh:targetClass time:Instant ;
	sh:property 
		[sh:path [sh:alternativePath ( time:inXSDDateTimeStamp time:inTimePosition) ] ;
		sh:nodeKind sh:BlankNodeOrLiteral;
		sh:minCount 1 ;
		sh:maxCount 1 ;
        sh:message "a time instant must be specified by only one of xsd DateTime or a TimePosition"
		] ;
	sh:property
		[sh:path time:inXSDDateTimeStamp ;
          sh:nodeKind  sh:Literal   ] ;
	sh:property
		[sh:path time:inTimePosition ;
           sh:class time:TimePosition ;
        	sh:message "inTimePosition must have a TimePosition object as a value"] 
	.
	
cdifd:timePositionNode
	a sh:NodeShape; 
	sh:targetClass time:TimePosition ;
	sh:property 	
		[
		sh:path time:hasTRS ;
		sh:nodeKind sh:IRIOrLiteral;
		sh:message "include identifier for the temporal reference system as a string or @id with a URI value"
		];	
	sh:property
		[
		sh:path time:numericPosition;
		sh:or ( [sh:datatype xsd:integer]
               [sh:datatype xsd:double] ) ;
		sh:message "time position MUST have a numeric value"
		]
	.
	
	
cdifd:variableMeasuredProperty
    a sh:PropertyShape ;
    sh:path schema:variableMeasured;
    sh:class schema:PropertyValue ;
	sh:property 
		[sh:path schema:name ;
		  sh:datatype xsd:string ;
		  sh:minCount 1;
		  sh:message "the name of the variable as it is labeled in the dataset must be specified"
		];
	sh:property 
		[sh:path schema:description ;
		  sh:datatype xsd:string ;
		  sh:minCount 1;
		  sh:severity sh:Info;
		  sh:message "including a description of the variable is strongly recommended"
		];
	sh:minCount 0;
    sh:message "if variable measured is specified, at least one PropertyValue description must be included" 
    .
	
cdifd:distributionProperty
	a sh:PropertyShape ;
	sh:or ( 
		[ sh:path 	schema:url   ;  
			sh:datatype xsd:anyURI ;
			sh:minCount 1 ;
			sh:message "The url property value is expected to be a link to a landing page for the described resource. The landing page should include information on how to access the resource"	]
		[sh:path schema:distribution ;
			sh:class  schema:DataDownload;
			sh:minCount 1;
			] )  ;
.

cdifd:dataDownloadNode
	a sh:NodeShape; 
	sh:targetClass schema:DataDownload ;
	sh:property 	
		[
		sh:path schema:contentURL ;
          sh:datatype xsd:anyURI ;
          sh:minCount 1 ;
		sh:message "A DataDownload node must have  contentURL that will get the resource in question"
		]
.